#!/usr/bin/env bash

set -e -o pipefail

# PATH needs to be updated since GNU Coreutils is required in OSX environments
GNUBIN="/usr/local/opt/coreutils/libexec/gnubin"
[[ -d "$GNUBIN" ]] && PATH="$GNUBIN:$PATH"

KYRAT_ROOT="$(readlink -f $(dirname $(readlink -f "$0"))/..)"

echo "\$* - $*"
# hack to not break `gcssh ... --command=...`, use ssh not kyrat if base64 in command (bash64 is used to create a string from --command=...)
# not sure if the '|| grep ...' actually works, but doesn't seem to break it
if grep -q base64 <<< "$@" || grep -qE " --$| -- " <<< "$*"; then
  ssh "$@"
else
  source "${KYRAT_ROOT}/lib/core.sh"

  kyrat "$@"
fi
